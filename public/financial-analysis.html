<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analyse Financi√®re - MYDental BI</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        .main-container {
            max-width: 1400px;
            margin: 20px auto;
            padding: 20px;
        }

        .page-title {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 30px;
        }

        .period-selector {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 30px;
            display: flex;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        .period-selector label {
            font-weight: 600;
            color: #2c3e50;
        }

        .period-selector input[type="date"] {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        .period-selector button {
            background: #3498db;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
        }

        .period-selector button:hover {
            background: #2980b9;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .metric-card {
            background: white;
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .metric-card h3 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 16px;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
        }

        .metric-value {
            font-size: 32px;
            font-weight: bold;
            color: #3498db;
            margin: 10px 0;
        }

        .metric-label {
            color: #7f8c8d;
            font-size: 14px;
        }

        .metric-secondary {
            display: flex;
            justify-content: space-between;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #ecf0f1;
        }

        .metric-secondary-item {
            text-align: center;
        }

        .metric-secondary-value {
            font-size: 20px;
            font-weight: bold;
            color: #34495e;
        }

        .metric-secondary-label {
            font-size: 12px;
            color: #7f8c8d;
            margin-top: 5px;
        }

        .chart-card {
            background: white;
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }

        .chart-card h3 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 18px;
        }

        .aging-bars {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .aging-bar-item {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .aging-bar-label {
            min-width: 120px;
            font-weight: 600;
            color: #2c3e50;
            font-size: 14px;
        }

        .aging-bar-container {
            flex: 1;
            height: 30px;
            background: #ecf0f1;
            border-radius: 4px;
            overflow: hidden;
            position: relative;
        }

        .aging-bar-fill {
            height: 100%;
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            padding: 0 10px;
            color: white;
            font-weight: bold;
            font-size: 12px;
        }

        .aging-bar-fill.green { background: #27ae60; }
        .aging-bar-fill.yellow { background: #f39c12; }
        .aging-bar-fill.orange { background: #e67e22; }
        .aging-bar-fill.red { background: #e74c3c; }

        .patients-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        .patients-table th {
            background: #34495e;
            color: white;
            padding: 12px;
            text-align: left;
            font-weight: 600;
            font-size: 14px;
        }

        .patients-table td {
            padding: 12px;
            border-bottom: 1px solid #ecf0f1;
            font-size: 14px;
        }

        .patients-table tr:hover {
            background: #f8f9fa;
        }

        .amount-unpaid {
            color: #e74c3c;
            font-weight: bold;
        }

        .recovery-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .recovery-stat-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 6px;
            text-align: center;
        }

        .recovery-stat-value {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .recovery-stat-label {
            font-size: 13px;
            color: #7f8c8d;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #7f8c8d;
        }

        .error-message {
            background: #fee;
            color: #c33;
            padding: 15px;
            border-radius: 4px;
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <!-- Navigation principale -->
    <nav class="main-nav">
        <a href="/" class="nav-brand">
            <img src="logo.png" alt="Logo" class="nav-logo">
            MYDental BI
        </a>
        <ul class="nav-links">
            <li><a href="/">Tableau de bord Clinique</a></li>
            <li><a href="/doctorPerformance.html">Performance M√©decins</a></li>
            <li><a href="/simulateur-rentabilite.html">Simulateur de Rentabilit√©</a></li>
            <li><a href="/financial-analysis.html" class="active">Analyse Financi√®re</a></li>
        </ul>
        <button id="logout-btn" class="nav-logout-btn">D√©connexion</button>
    </nav>

    <!-- Titre de la page -->
    <h1 class="page-title">üìä Analyse Financi√®re Avanc√©e - Gestion des Impay√©s</h1>

    <!-- S√©lecteur de p√©riode -->
    <div class="period-selector">
        <label for="start-date">P√©riode d'analyse - D√©but :</label>
        <input type="date" id="start-date" name="start-date">
        
        <label for="end-date">Fin :</label>
        <input type="date" id="end-date" name="end-date">
        
        <button id="apply-period">Appliquer</button>
    </div>

    <div class="main-container">
        <!-- Indicateurs cl√©s -->
        <div class="metrics-grid" id="metrics-grid">
            <div class="metric-card">
                <h3>üí∞ Taux d'Impay√©s Global</h3>
                <div class="metric-value" id="unpaid-rate">-</div>
                <div class="metric-label">Pourcentage du CA non encaiss√©</div>
                <div class="metric-secondary">
                    <div class="metric-secondary-item">
                        <div class="metric-secondary-value" id="total-amount">-</div>
                        <div class="metric-secondary-label">CA Total</div>
                    </div>
                    <div class="metric-secondary-item">
                        <div class="metric-secondary-value" id="total-remaining">-</div>
                        <div class="metric-secondary-label">Impay√©s</div>
                    </div>
                </div>
            </div>

            <div class="metric-card">
                <h3>üìà Taux de Recouvrement</h3>
                <div class="metric-value" id="full-payment-rate">-</div>
                <div class="metric-label">Paiements complets</div>
                <div class="metric-secondary">
                    <div class="metric-secondary-item">
                        <div class="metric-secondary-value" id="partial-payment-rate">-</div>
                        <div class="metric-secondary-label">Paiements partiels</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Cr√©ances par anciennet√© -->
        <div class="chart-card">
            <h3>‚è∞ Cr√©ances par Anciennet√©</h3>
            <div class="aging-bars" id="aging-bars">
                <div class="loading">Chargement des donn√©es...</div>
            </div>
        </div>

        <!-- Top 10 patients avec impay√©s -->
        <div class="chart-card">
            <h3>üë• Top 10 Patients avec Soldes Impay√©s</h3>
            <table class="patients-table" id="patients-table">
                <thead>
                    <tr>
                        <th>#</th>
                        <th>Patient</th>
                        <th>Montant Impay√©</th>
                        <th>Nombre de Paiements</th>
                        <th>Dernier Paiement</th>
                    </tr>
                </thead>
                <tbody>
                    <tr><td colspan="5" class="loading">Chargement des donn√©es...</td></tr>
                </tbody>
            </table>
        </div>

        <!-- √âvolution mensuelle -->
        <div class="chart-card">
            <h3>üìä √âvolution Mensuelle des Cr√©ances</h3>
            <div id="monthly-chart" class="loading">Chargement des donn√©es...</div>
        </div>

        <!-- Statistiques de recouvrement -->
        <div class="chart-card">
            <h3>üí≥ D√©tail des Paiements</h3>
            <div class="recovery-stats" id="recovery-stats">
                <div class="loading">Chargement des donn√©es...</div>
            </div>
        </div>
    </div>

    <script>
        // Gestion de l'authentification
        const token = localStorage.getItem('token');
        if (!token) {
            window.location.href = '/login.html';
        }

        // Configuration des dates par d√©faut
        function setDefaultDates() {
            const endDate = new Date();
            const startDate = new Date();
            startDate.setMonth(startDate.getMonth() - 6);
            
            document.getElementById('start-date').value = startDate.toISOString().split('T')[0];
            document.getElementById('end-date').value = endDate.toISOString().split('T')[0];
        }

        // Fonction pour formater les montants
        function formatCurrency(amount) {
            return new Intl.NumberFormat('fr-FR', {
                style: 'currency',
                currency: 'MAD'
            }).format(amount || 0);
        }

        // Fonction pour formater les dates
        function formatDate(dateString) {
            if (!dateString) return '-';
            const date = new Date(dateString);
            return date.toLocaleDateString('fr-FR');
        }

        // Chargement du taux d'impay√©s
        async function loadUnpaidRate() {
            const startDate = document.getElementById('start-date').value;
            const endDate = document.getElementById('end-date').value;

            try {
                const response = await fetch(`/api/financial-analysis/unpaid-rate?startDate=${startDate}&endDate=${endDate}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await response.json();

                document.getElementById('unpaid-rate').textContent = (data.unpaid_rate_percent || 0) + '%';
                document.getElementById('total-amount').textContent = formatCurrency(data.total_amount);
                document.getElementById('total-remaining').textContent = formatCurrency(data.total_remaining);
            } catch (error) {
                console.error('Erreur lors du chargement du taux d\'impay√©s:', error);
            }
        }

        // Chargement des cr√©ances par anciennet√©
        async function loadReceivablesAging() {
            const startDate = document.getElementById('start-date').value;
            const endDate = document.getElementById('end-date').value;

            try {
                const response = await fetch(`/api/financial-analysis/receivables-aging?startDate=${startDate}&endDate=${endDate}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await response.json();

                const total = data.total_receivables || 1;
                const agingBarsHtml = `
                    <div class="aging-bar-item">
                        <div class="aging-bar-label">&lt; 30 jours</div>
                        <div class="aging-bar-container">
                            <div class="aging-bar-fill green" style="width: ${(data.less_than_30_days / total * 100)}%">
                                ${formatCurrency(data.less_than_30_days)}
                            </div>
                        </div>
                    </div>
                    <div class="aging-bar-item">
                        <div class="aging-bar-label">30-60 jours</div>
                        <div class="aging-bar-container">
                            <div class="aging-bar-fill yellow" style="width: ${(data.between_30_60_days / total * 100)}%">
                                ${formatCurrency(data.between_30_60_days)}
                            </div>
                        </div>
                    </div>
                    <div class="aging-bar-item">
                        <div class="aging-bar-label">60-90 jours</div>
                        <div class="aging-bar-container">
                            <div class="aging-bar-fill orange" style="width: ${(data.between_60_90_days / total * 100)}%">
                                ${formatCurrency(data.between_60_90_days)}
                            </div>
                        </div>
                    </div>
                    <div class="aging-bar-item">
                        <div class="aging-bar-label">&gt; 90 jours</div>
                        <div class="aging-bar-container">
                            <div class="aging-bar-fill red" style="width: ${(data.more_than_90_days / total * 100)}%">
                                ${formatCurrency(data.more_than_90_days)}
                            </div>
                        </div>
                    </div>
                `;
                document.getElementById('aging-bars').innerHTML = agingBarsHtml;
            } catch (error) {
                console.error('Erreur lors du chargement des cr√©ances par anciennet√©:', error);
                document.getElementById('aging-bars').innerHTML = '<div class="error-message">Erreur de chargement</div>';
            }
        }

        // Chargement des top patients avec impay√©s
        async function loadTopUnpaidPatients() {
            const startDate = document.getElementById('start-date').value;
            const endDate = document.getElementById('end-date').value;

            try {
                const response = await fetch(`/api/financial-analysis/top-unpaid-patients?startDate=${startDate}&endDate=${endDate}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await response.json();

                const tbody = document.querySelector('#patients-table tbody');
                if (data.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" style="text-align: center;">Aucun patient avec impay√©s</td></tr>';
                    return;
                }

                tbody.innerHTML = data.map((patient, index) => `
                    <tr>
                        <td>${index + 1}</td>
                        <td>${patient.patient_name}</td>
                        <td class="amount-unpaid">${formatCurrency(patient.total_unpaid)}</td>
                        <td>${patient.payment_count}</td>
                        <td>${formatDate(patient.last_payment_date)}</td>
                    </tr>
                `).join('');
            } catch (error) {
                console.error('Erreur lors du chargement des patients avec impay√©s:', error);
            }
        }

        // Chargement du taux de recouvrement
        async function loadRecoveryRate() {
            const startDate = document.getElementById('start-date').value;
            const endDate = document.getElementById('end-date').value;

            try {
                const response = await fetch(`/api/financial-analysis/recovery-rate?startDate=${startDate}&endDate=${endDate}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await response.json();

                document.getElementById('full-payment-rate').textContent = (data.full_payment_rate || 0) + '%';
                document.getElementById('partial-payment-rate').textContent = (data.partial_payment_rate || 0) + '%';

                const recoveryStatsHtml = `
                    <div class="recovery-stat-item">
                        <div class="recovery-stat-value" style="color: #27ae60;">${data.full_payments || 0}</div>
                        <div class="recovery-stat-label">Paiements complets</div>
                    </div>
                    <div class="recovery-stat-item">
                        <div class="recovery-stat-value" style="color: #f39c12;">${data.partial_payments || 0}</div>
                        <div class="recovery-stat-label">Paiements partiels</div>
                    </div>
                    <div class="recovery-stat-item">
                        <div class="recovery-stat-value" style="color: #e74c3c;">${data.no_payments || 0}</div>
                        <div class="recovery-stat-label">Aucun paiement</div>
                    </div>
                    <div class="recovery-stat-item">
                        <div class="recovery-stat-value" style="color: #3498db;">${data.total_payments || 0}</div>
                        <div class="recovery-stat-label">Total paiements</div>
                    </div>
                `;
                document.getElementById('recovery-stats').innerHTML = recoveryStatsHtml;
            } catch (error) {
                console.error('Erreur lors du chargement du taux de recouvrement:', error);
            }
        }

        // Chargement de l'√©volution mensuelle
        async function loadMonthlyEvolution() {
            const startDate = document.getElementById('start-date').value;
            const endDate = document.getElementById('end-date').value;

            try {
                const response = await fetch(`/api/financial-analysis/monthly-receivables?startDate=${startDate}&endDate=${endDate}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await response.json();

                if (data.length === 0) {
                    document.getElementById('monthly-chart').innerHTML = '<p style="text-align: center;">Aucune donn√©e disponible</p>';
                    return;
                }

                const chartHtml = `
                    <table class="patients-table">
                        <thead>
                            <tr>
                                <th>Mois</th>
                                <th>CA Total</th>
                                <th>Impay√©s</th>
                                <th>Taux d'Impay√©s</th>
                                <th>Nb Paiements</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${data.map(row => `
                                <tr>
                                    <td>${row.month}</td>
                                    <td>${formatCurrency(row.total_amount)}</td>
                                    <td class="amount-unpaid">${formatCurrency(row.total_remaining)}</td>
                                    <td>${row.unpaid_rate_percent || 0}%</td>
                                    <td>${row.payment_count}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
                document.getElementById('monthly-chart').innerHTML = chartHtml;
            } catch (error) {
                console.error('Erreur lors du chargement de l\'√©volution mensuelle:', error);
                document.getElementById('monthly-chart').innerHTML = '<div class="error-message">Erreur de chargement</div>';
            }
        }

        // Charger toutes les donn√©es
        function loadAllData() {
            loadUnpaidRate();
            loadReceivablesAging();
            loadTopUnpaidPatients();
            loadRecoveryRate();
            loadMonthlyEvolution();
        }

        // Event listeners
        document.getElementById('apply-period').addEventListener('click', loadAllData);

        document.getElementById('logout-btn').addEventListener('click', () => {
            localStorage.removeItem('token');
            window.location.href = '/login.html';
        });

        // Initialisation
        setDefaultDates();
        loadAllData();
    </script>
</body>
</html>
